tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/4.5.5/types.yaml
  - plugin:cloudify-openstack-plugin

inputs:
  manager_network:
    default: external
  agent_key_private:
    description: >
      The content of the agent's private key.
    default: { get_secret: agent_key_private }
  agent_user:
    description: >
      The username of the agent running on the instance created from the image.
    default: ubuntu
  image_name:
    description: >
      An Openstack Image ID. Tested with a Ubuntu 14.04 image.
    type: string
    default: { get_secret: ubuntu_trusty_image }
  flavor:
    description: >
      An Openstack Flavor ID.
    default: '2'
  key_pair_name:
    description: key pair name
  vm_network_list:
    description: list of connected to network

dsl_definitions:
  openstack_config: &openstack_config
    username: { get_secret: keystone_username }
    password: { get_secret: keystone_password }
    tenant_name: { get_secret: keystone_tenant_name }
    auth_url: { get_secret: keystone_url }
    region: { get_secret: region }

node_types:
  host:
    derived_from: cloudify.openstack.nodes.Server
    properties:
      openstack_config: *openstack_config
      server:
        networks: { get_input: vm_network_list }
      agent_config:
        network: { get_input: manager_network }
        user: { get_input: agent_user }
        install_method: init_script
        port: 22
        key: { get_input: agent_key_private }
      server:
        key_name: { get_input: key_pair_name }
        image: { get_input: image_name }
        flavor: { get_input: flavor }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: openstack.nova_plugin.server.create
          inputs:
            args:
              image: { get_input: image }
              flavor: { get_input: flavor }
